ARG DOCKER_IMAGE_NODE

FROM ${DOCKER_IMAGE_NODE} as base
RUN apk add --no-cache git
WORKDIR /usr/src/app/
RUN chown node:node /usr/src/app/
USER node

FROM base as node
COPY patches ./patches/
COPY package.json package-lock.json ./
RUN npm ci
COPY webpack.config.js ./
COPY assets ./assets/
COPY src ./src/
RUN npm run build

FROM fholzer/nginx-brotli:v1.18.0
## remove nginx welcome page
RUN rm /usr/share/nginx/html/*
COPY docker/nginx/nginx.conf /etc/nginx/nginx.conf
COPY docker/nginx/default.conf /etc/nginx/conf.d/default.conf
COPY docker/nginx/start.sh /start.sh
RUN chmod 755 /start.sh
CMD ["/start.sh"]
COPY ./public/ /usr/share/nginx/html/
COPY --from=node /usr/src/app/dist/ /usr/share/nginx/html/
